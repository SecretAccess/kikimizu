<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テイスティングチャレンジ</title>
    <!-- Sortable.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-light: #BBDEFB;
            --primary-dark: #1976D2;
            --primary-lightest: #E3F2FD;
            --accent-color: #00BCD4;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --error-color: #F44336;
            --text-color: #333;
            --light-text: #757575;
            --light-bg: #F5F9FF;
            --card-bg: #FFFFFF;
            --dealer-color: #9C27B0;
            --dealer-light: #E1BEE7;
            --player-color: #00BCD4;
            --player-light: #B2EBF2;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: all 0.2s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            line-height: 1.6;
        }

        #app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
            color: var(--primary-color);
        }

        .logo-text {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .mode-label {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .dealer-mode-label {
            background-color: var(--dealer-light);
            color: var(--dealer-color);
        }

        .player-mode-label {
            background-color: var(--player-light);
            color: var(--player-color);
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .mode-button {
            padding: 15px 30px;
            margin: 0 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dealer-button {
            background-color: var(--dealer-light);
            color: var(--dealer-color);
        }

        .dealer-button:hover {
            background-color: var(--dealer-color);
            color: white;
            transform: translateY(-5px);
        }

        .player-button {
            background-color: var(--player-light);
            color: var(--player-color);
        }

        .player-button:hover {
            background-color: var(--player-color);
            color: white;
            transform: translateY(-5px);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 20px;
            transition: all 0.3s ease-in-out;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 20px;
        }

        .dealer-card .card-title {
            color: var(--dealer-color);
        }

        .player-card .card-title {
            color: var(--player-color);
        }

        .card-content {
            margin-bottom: 20px;
        }

        .stage {
            display: none;
        }

        h2 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-weight: 600;
        }

        p {
            margin-bottom: 15px;
            color: var(--light-text);
        }

        .item-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .item-grid label {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease;
        }

        .item-grid label:hover {
            transform: translateY(-5px);
        }

        .item-img-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .item-grid img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .item-grid label:hover .item-img-container img {
            transform: scale(1.1);
        }

        .item-grid input[type="checkbox"],
        .item-grid input[type="radio"] {
            display: none;
        }

        .item-grid input[type="checkbox"]:checked + .item-img-container,
        .item-grid input[type="radio"]:checked + .item-img-container {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .item-name {
            margin-top: 10px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }

        .btn {
            margin: 10px 5px;
            padding: 12px 24px;
            font-size: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }

        .btn-dealer {
            background-color: var(--dealer-color);
        }

        .btn-dealer:hover {
            background-color: #7B1FA2;
        }

        .btn-player {
            background-color: var(--player-color);
        }

        .btn-player:hover {
            background-color: #0097A7;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #388E3C;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #FFA000;
        }

        .btn-danger {
            background-color: var(--error-color);
        }

        .btn-danger:hover {
            background-color: #D32F2F;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
        }

        .error {
            color: var(--error-color);
            margin: 15px 0;
            font-size: 14px;
            background-color: rgba(244, 67, 54, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            display: none;
        }

        .sortable-list {
            list-style-type: none;
            padding: 0;
            margin: 25px auto;
            width: 100%;
            max-width: 500px;
        }

        .sortable-list li {
            padding: 15px;
            margin: 10px 0;
            background-color: var(--card-bg);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: move;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .sortable-list li:hover {
            background-color: #f9f9f9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .sortable-list li img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .sortable-list li .handle {
            margin-left: auto;
            color: #bdbdbd;
            cursor: move;
        }

        .cup-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
            padding: 20px;
            background-color: var(--primary-lightest);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .cup-number {
            font-size: 48px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .cup-label {
            font-size: 18px;
            color: var(--light-text);
        }

        .dealer-note {
            margin: 20px 0;
            padding: 15px;
            background-color: var(--dealer-light);
            border-radius: 8px;
            text-align: left;
            font-size: 15px;
            color: var(--dealer-color);
        }

        .dealer-note i {
            margin-right: 8px;
        }

        .comparison {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .comparison-column {
            flex: 1;
            min-width: 250px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .comparison-column h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }

        .dealer-column h3 {
            color: var(--dealer-color);
            border-bottom-color: var(--dealer-light);
        }

        .player-column h3 {
            color: var(--player-color);
            border-bottom-color: var(--player-light);
        }

        .comparison-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .comparison-item.correct {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--success-color);
        }

        .comparison-item.incorrect {
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 4px solid var(--error-color);
        }

        .comparison-item img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .comparison-item-text {
            text-align: left;
        }

        .cup-number-small {
            font-weight: bold;
            font-size: 14px;
            color: var(--light-text);
        }

        .item-title {
            font-weight: 500;
            font-size: 16px;
        }

        #result-message, #player-result-message {
            font-size: 20px;
            margin: 25px 0;
            font-weight: 600;
            color: var(--primary-dark);
            padding: 15px;
            background-color: var(--primary-light);
            border-radius: 8px;
            display: inline-block;
        }

        .result-stat {
            display: inline-block;
            padding: 10px 20px;
            margin: 10px;
            background-color: var(--primary-lightest);
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .result-stat .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-dark);
            display: block;
        }

        .result-stat .label {
            font-size: 14px;
            color: var(--light-text);
        }

        .result-confetti {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* テイスティングセクション */
        .tasting-section {
            padding: 20px;
            margin: 20px 0;
            background-color: var(--player-light);
            border-radius: var(--border-radius);
        }

        .tasting-section h3 {
            color: var(--player-color);
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* 追加ボタンスタイル */
        .add-item-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--accent-color);
            color: white;
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-item-button:hover {
            background-color: #00ACC1;
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* 画像アップロード用のモーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            margin-bottom: 20px;
            color: var(--primary-dark);
            font-size: 20px;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="password"]:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .file-upload {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f9f9f9;
            margin-top: 15px;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background-color: rgba(33, 150, 243, 0.05);
        }

        .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload i {
            font-size: 36px;
            color: #bdbdbd;
            margin-bottom: 10px;
        }

        .file-upload-text {
            font-size: 14px;
            color: var(--light-text);
        }

        .image-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin: 15px auto;
            display: none;
            border: 3px solid var(--primary-light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .test-config-details {
            background-color: var(--primary-lightest);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .test-config-details h3 {
            font-size: 18px;
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .config-list {
            margin: 0;
            padding: 0;
            list-style-type: none;
        }

        .config-list li {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .config-list li:last-child {
            border-bottom: none;
        }

        .config-list li img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .printed-instructions {
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            border: 1px dashed #ccc;
            border-radius: 8px;
            text-align: left;
        }

        .printed-instructions h3 {
            margin-bottom: 15px;
            color: var(--primary-dark);
        }

        .printed-instructions ol {
            margin-left: 20px;
        }

        .printed-instructions li {
            margin-bottom: 10px;
        }

        .printed-instructions .item-list {
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .session-id {
            font-size: 14px;
            background-color: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 5px;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
        }

        .accordion {
            margin: 20px 0;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .accordion-header {
            padding: 15px;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .accordion-header:hover {
            background-color: var(--primary-lightest);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: white;
            padding: 0 15px;
        }

        .accordion-content.show {
            max-height: 500px;
            padding: 15px;
        }

        /* ホームボタン */
        .home-button {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background-color: var(--primary-color);
            color: white;
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .home-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* ロック用の覆い */
        .screen-cover {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1500;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .cover-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .cover-title {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .cover-message {
            font-size: 18px;
            max-width: 400px;
            text-align: center;
            margin-bottom: 30px;
        }

        /* テーマセレクター */
        .theme-selector {
            margin-top: 20px;
        }

        .theme-selector h3 {
            margin-bottom: 15px;
            color: var(--primary-dark);
        }

        .theme-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .theme-option {
            padding: 8px 16px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-option:hover, .theme-option.active {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }

        /* 結果表示の強化 */
        .results-summary {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }

        .result-badge {
            text-align: center;
            padding: 20px;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .result-badge.correct {
            background-color: rgba(76, 175, 80, 0.1);
            border: 3px solid var(--success-color);
        }

        .result-badge.total {
            background-color: rgba(33, 150, 243, 0.1);
            border: 3px solid var(--primary-color);
        }

        .result-badge.accuracy {
            background-color: rgba(255, 193, 7, 0.1);
            border: 3px solid var(--warning-color);
        }

        .badge-value {
            font-size: 36px;
            font-weight: bold;
            line-height: 1;
        }

        .badge-label {
            font-size: 14px;
            margin-top: 5px;
        }

        .rating-stars {
            margin-top: 20px;
            font-size: 24px;
            color: #FFC107;
        }

        /* マスキング要素 */
        .mask-element {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: #b32626;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            border-radius: var(--border-radius);
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            #app-container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .item-grid label {
                width: 100px;
            }

            .item-img-container {
                width: 80px;
                height: 80px;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .comparison {
                flex-direction: column;
                gap: 20px;
            }

            .comparison-column {
                width: 100%;
            }

            .mode-selector {
                flex-direction: column;
                gap: 15px;
            }

            .mode-button {
                margin: 0;
            }

            .home-button, .add-item-button {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .item-grid {
                gap: 10px;
            }

            .item-grid label {
                width: 80px;
            }

            .item-img-container {
                width: 70px;
                height: 70px;
            }

            .item-name {
                font-size: 12px;
            }

            .cup-number {
                font-size: 36px;
            }

            .cup-label {
                font-size: 16px;
            }

            .result-badge {
                width: 100px;
                height: 100px;
            }

            .badge-value {
                font-size: 28px;
            }
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .slide-up {
            animation: slideUp 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- ヘッダー -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-glass-martini-alt logo-icon"></i>
                <div class="logo-text">テイスティングチャレンジ</div>
            </div>
            <div class="mode-indicators">
                <div id="dealer-mode-label" class="mode-label dealer-mode-label">
                    <i class="fas fa-user-tie"></i> 出題者モード
                </div>
                <div id="player-mode-label" class="mode-label player-mode-label">
                    <i class="fas fa-user"></i> 回答者モード
                </div>
            </div>
        </div>

        <!-- ホーム画面 -->
        <div id="home-screen" class="stage" style="display:block;">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-home"></i> テイスティングチャレンジへようこそ
                </div>
                <div class="card-content">
                    <p>このアプリでは、水や飲み物、食べ物などの味を当てるチャレンジゲームを楽しむことができます。</p>
                    <p>始めるには、役割を選択してください。</p>
                </div>
                <div class="mode-selector">
                    <button id="dealer-button" class="mode-button dealer-button">
                        <i class="fas fa-user-tie"></i> 出題者
                    </button>
                    <button id="player-button" class="mode-button player-button">
                        <i class="fas fa-user"></i> 回答者
                    </button>
                </div>

                <!-- テーマセレクター -->
                <div class="theme-selector">
                    <h3>テーマの選択</h3>
                    <div class="theme-options">
                        <div class="theme-option active" data-theme="water">水の利き比べ</div>
                        <div class="theme-option" data-theme="wine">ワインテイスティング</div>
                        <div class="theme-option" data-theme="fruit">フルーツ食べ比べ</div>
                        <div class="theme-option" data-theme="coffee">コーヒーテイスティング</div>
                        <div class="theme-option" data-theme="custom">カスタム</div>
                    </div>
                </div>

                <!-- 保存データのリセット -->
                <div class="form-group" style="margin-top: 30px; text-align: center;">
                    <button id="reset-data" class="btn btn-danger"><i class="fas fa-trash"></i>保存データをリセット</button>
                </div>
            </div>

            <!-- 遊び方の説明 -->
            <div class="accordion">
                <div class="accordion-header">
                    <span>遊び方を見る</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content">
                    <h3>テイスティングチャレンジの遊び方</h3>
                    <p>このゲームは出題者と回答者に分かれて行います。</p>
                    
                    <h4>出題者の役割</h4>
                    <ol>
                        <li>テストに使用する複数のアイテムを選択します</li>
                        <li>アイテムを提供する順番を決めます</li>
                        <li>決めた順番で実際にアイテムを回答者に提供します</li>
                    </ol>
                    
                    <h4>回答者の役割</h4>
                    <ol>
                        <li>出題者から一つずつアイテムを受け取り、味わいます</li>
                        <li>各試飲ごとに「これは何か」という仮回答を記録します</li>
                        <li>すべてのアイテムを試した後、最終回答を提出します</li>
                    </ol>
                    
                    <p>最終的に、回答者の回答と出題者の出題を照合し、正解数を確認します。</p>
                </div>
            </div>
        </div>

        <!-- 出題者モード -->
        <div id="dealer-section" class="stage">
            <!-- 出題者ステージ1: アイテムの選択 -->
            <div id="dealer-stage-1" class="card dealer-card">
                <div class="card-title">
                    <i class="fas fa-list-ul"></i> アイテムの選択
                </div>
                <div class="card-content">
                    <p>テストに使用するアイテムを2つ以上選択してください。</p>
                    <div class="form-group">
                        <label for="test-name">テスト名</label>
                        <input type="text" id="test-name" placeholder="例: 水の利き比べ">
                    </div>
                    <div id="item-selection" class="item-grid">
                        <!-- アイテムがここに表示される -->
                    </div>
                </div>
                <button id="next-to-order" class="btn btn-dealer"><i class="fas fa-arrow-right"></i>次へ進む</button>
                <div id="item-error" class="error"></div>
            </div>

            <!-- 出題者ステージ2: 順番の設定 -->
            <div id="dealer-stage-2" class="card dealer-card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-sort-amount-down"></i> 提供順序の設定
                </div>
                <div class="card-content">
                    <p>アイテムを提供する順番に並び替えてください。この順番で回答者に提供します。</p>
                    <ul id="order-list" class="sortable-list">
                        <!-- 選択したアイテムがここに表示される -->
                    </ul>
                </div>
                <button id="confirm-order" class="btn btn-dealer"><i class="fas fa-check"></i>この順番で確定</button>
            </div>

            <!-- 出題者ステージ3: 手順確認 -->
            <div id="dealer-stage-3" class="card dealer-card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-clipboard-list"></i> 手順確認
                </div>
                <div class="card-content">
                    <p>テスト設定が完了しました。以下の手順で実施してください。</p>
                    <div class="test-config-details">
                        <h3>テスト情報</h3>
                        <p>テスト名: <span id="test-name-display"></span></p>
                        <p>使用するアイテム数: <span id="item-count"></span>種類</p>
                    </div>
                </div>
                <button id="generate-instructions" class="btn btn-dealer"><i class="fas fa-print"></i>手順書を表示</button>
                <button id="start-test" class="btn btn-success"><i class="fas fa-play"></i>テストを開始</button>
            </div>

            <!-- 手順書表示エリア -->
            <div id="instructions-card" class="card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-file-alt"></i> テイスティングチャレンジ手順書
                </div>
                <div class="printed-instructions">
                    <h3>出題者用手順</h3>
                    <ol>
                        <li>以下のアイテムを準備してください：</li>
                        <div id="item-list" class="item-list"></div>
                        <li>アイテムを回答者に以下の順番で提供してください：</li>
                        <div id="serving-order" class="item-list"></div>
                        <li>「回答者モード」に切り替えて、回答者にテストを受けてもらってください。</li>
                        <li>各試飲ごとに回答者が仮回答を記録したら、次のアイテムを提供してください。</li>
                    </ol>
                </div>
                <button id="print-instructions" class="btn"><i class="fas fa-print"></i>印刷する</button>
                <button id="back-to-setup" class="btn btn-outline"><i class="fas fa-arrow-left"></i>戻る</button>
            </div>

            <!-- アイテム提供画面 -->
            <div id="dealer-serving" class="card dealer-card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-hand-holding"></i> アイテム提供
                </div>
                <div class="cup-display">
                    <div class="cup-number" id="dealer-current-cup">1</div>
                    <div class="cup-label">杯目</div>
                </div>
                <div class="card-content">
                    <p>以下のアイテムを回答者に提供してください：</p>
                    <div class="dealer-item-display" style="margin: 20px 0; padding: 15px; background-color: var(--dealer-light); border-radius: 8px;">
                        <img id="dealer-item-img" src="" alt="" style="width: 100px; height: 100px; border-radius: 50%; margin: 10px auto; display: block; object-fit: cover;">
                        <h3 id="dealer-item-name" style="color: var(--dealer-color); font-size: 22px; text-align: center;"></h3>
                    </div>
                    <p>回答者が仮回答を入力したら、「次へ」ボタンを押してください。</p>
                </div>
                <button id="next-item" class="btn btn-dealer"><i class="fas fa-arrow-right"></i>次へ</button>
            </div>

            <!-- 結果表示画面 (出題者用) -->
            <div id="dealer-results-screen" class="card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-trophy"></i> テスト結果
                </div>
                <div class="results-summary">
                    <div class="result-badge correct">
                        <div class="badge-value" id="correct-count">0</div>
                        <div class="badge-label">正解数</div>
                    </div>
                    <div class="result-badge total">
                        <div class="badge-value" id="total-count">0</div>
                        <div class="badge-label">出題数</div>
                    </div>
                    <div class="result-badge accuracy">
                        <div class="badge-value" id="accuracy-percent">0%</div>
                        <div class="badge-label">正解率</div>
                    </div>
                </div>
                <div class="rating-stars" id="rating-stars"></div>
                <div class="comparison">
                    <div class="comparison-column dealer-column">
                        <h3>出題内容</h3>
                        <div id="dealer-results">
                            <!-- 出題者の選択を表示 -->
                        </div>
                    </div>
                    <div class="comparison-column player-column">
                        <h3>回答者の回答</h3>
                        <div id="player-results">
                            <!-- 回答者の選択を表示 -->
                        </div>
                    </div>
                </div>
                <button id="new-test" class="btn btn-dealer"><i class="fas fa-plus"></i>新しいテストを作成</button>
                <button id="go-home" class="btn btn-outline"><i class="fas fa-home"></i>ホームに戻る</button>
            </div>
        </div>

        <!-- 回答者モード -->
        <div id="player-section" class="stage">
            <!-- 回答者ステージ1: テストに参加 -->
            <div id="player-stage-1" class="card player-card">
                <div class="card-title">
                    <i class="fas fa-sign-in-alt"></i> テストに参加
                </div>
                <div class="card-content">
                    <p>出題者が作成したテストに参加します。</p>
                    <div class="test-config-details">
                        <h3>テスト情報</h3>
                        <p>テスト名: <span id="player-test-name"></span></p>
                        <p>アイテム数: <span id="player-item-count"></span>種類</p>
                    </div>
                    <p>出題者がアイテムを準備したら、「テストを開始する」ボタンを押してください。</p>
                </div>
                <button id="start-player-test" class="btn btn-player"><i class="fas fa-play"></i>テストを開始する</button>
            </div>

            <!-- テイスティングプロセス -->
            <div id="tasting-process" class="card player-card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-utensils"></i> テイスティング
                </div>
                <div class="cup-display">
                    <div class="cup-number" id="current-cup-display">1</div>
                    <div class="cup-label">杯目</div>
                </div>
                <div class="card-content">
                    <p>現在のアイテムについて、正解だと思うものを選択してください（複数選択可）。</p>
                    <div id="player-item-selection" class="item-grid">
                        <!-- 選択肢がここに表示される -->
                    </div>
                </div>
                <button id="submit-guess" class="btn btn-player"><i class="fas fa-check"></i>選択を確定</button>
                <div id="guess-error" class="error"></div>
            </div>

            <!-- 最終回答画面 -->
            <div id="final-answer" class="card player-card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-flag-checkered"></i> 最終回答
                </div>
                <div class="card-content">
                    <p>すべてのアイテムをテイスティングしました。提供された順番でアイテムの種類を選択してください。</p>
                    <div id="provisional-answers">
                        <h3>途中回答の記録</h3>
                        <!-- 途中回答の記録がここに表示される -->
                    </div>
                    <div id="final-answer-form">
                        <!-- 最終回答フォームがここに表示される -->
                    </div>
                </div>
                <button id="submit-final" class="btn btn-success"><i class="fas fa-paper-plane"></i>最終回答を提出</button>
                <div id="final-error" class="error"></div>
            </div>

            <!-- 結果表示画面 (回答者用) -->
            <div id="player-results-screen" class="card" style="display:none;">
                <div class="card-title">
                    <i class="fas fa-trophy"></i> テスト結果
                </div>
                <div class="results-summary">
                    <div class="result-badge correct">
                        <div class="badge-value" id="player-correct-count">0</div>
                        <div class="badge-label">正解数</div>
                    </div>
                    <div class="result-badge total">
                        <div class="badge-value" id="player-total-count">0</div>
                        <div class="badge-label">出題数</div>
                    </div>
                    <div class="result-badge accuracy">
                        <div class="badge-value" id="player-accuracy-percent">0%</div>
                        <div class="badge-label">正解率</div>
                    </div>
                </div>
                <div class="rating-stars" id="player-rating-stars"></div>
                <div class="comparison">
                    <div class="comparison-column dealer-column">
                        <h3>正解</h3>
                        <div id="correct-answers">
                            <!-- 正解を表示 -->
                        </div>
                    </div>
                    <div class="comparison-column player-column">
                        <h3>あなたの回答</h3>
                        <div id="your-answers">
                            <!-- 回答者の回答を表示 -->
                        </div>
                    </div>
                </div>
                <button id="try-again" class="btn btn-player"><i class="fas fa-redo"></i>もう一度チャレンジ</button>
                <button id="player-go-home" class="btn btn-outline"><i class="fas fa-home"></i>ホームに戻る</button>
            </div>
        </div>

        <!-- 追加ボタン (出題者モードでのみ表示) -->
        <button id="add-item-button" class="add-item-button" style="display:none;">
            <i class="fas fa-plus"></i>
        </button>

        <!-- ホームボタン -->
        <button id="home-button" class="home-button">
            <i class="fas fa-home"></i>
        </button>

        <!-- スクリーンカバー (役割切り替え時に使用) -->
        <div id="screen-cover" class="screen-cover">
            <i class="fas fa-exchange-alt cover-icon"></i>
            <div class="cover-title">役割を切り替えています</div>
            <div class="cover-message">デバイスを回答者に渡してください。準備ができたらタップしてください。</div>
            <button id="cover-continue" class="btn btn-success"><i class="fas fa-check"></i>準備ができました</button>
        </div>
    </div>

    <!-- 画像アップロードモーダル -->
    <div id="add-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">新しいアイテムを追加</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="item-name">アイテム名</label>
                    <input type="text" id="item-name" placeholder="例: エビアン">
                </div>
                <div class="form-group">
                    <label>アイテムの画像</label>
                    <div class="image-preview" id="image-preview">
                        <img id="preview-img" src="" alt="画像プレビュー">
                    </div>
                    <div class="file-upload">
                        <input type="file" id="item-image" accept="image/*">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <div class="file-upload-text">クリックして画像を選択 または ドラッグ&ドロップ</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="item-category">カテゴリ</label>
                    <select id="item-category">
                        <option value="water">水</option>
                        <option value="wine">ワイン</option>
                        <option value="fruit">フルーツ</option>
                        <option value="coffee">コーヒー</option>
                        <option value="other">その他</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-add"><i class="fas fa-times"></i>キャンセル</button>
                <button class="btn btn-dealer" id="confirm-add"><i class="fas fa-plus"></i>追加</button>
            </div>
        </div>
    </div>

    <!-- 確認ダイアログモーダル -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">確認</div>
            <div class="modal-body">
                <p id="confirm-message">本当に実行しますか？</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-confirm"><i class="fas fa-times"></i>キャンセル</button>
                <button class="btn btn-danger" id="proceed-confirm"><i class="fas fa-check"></i>実行する</button>
            </div>
        </div>
    </div>

    <!-- 通知表示用 -->
    <div id="notification" class="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // グローバル変数
            let selectedItems = [];
            let dealerOrder = [];
            let customItems = [];
            let defaultItems = {};
            let gameMode = '';
            let currentCup = 1;
            let totalCups = 0;
            let playerProvisionalAnswers = [];
            let playerFinalAnswers = [];
            let testResults = null;
            let activeTheme = 'water';
            let testName = '';
            
            // DOM要素
            const homeScreen = document.getElementById('home-screen');
            const dealerSection = document.getElementById('dealer-section');
            const playerSection = document.getElementById('player-section');
            const dealerModeLabel = document.getElementById('dealer-mode-label');
            const playerModeLabel = document.getElementById('player-mode-label');
            const addItemButton = document.getElementById('add-item-button');
            const homeButton = document.getElementById('home-button');
            const screenCover = document.getElementById('screen-cover');
            const addItemModal = document.getElementById('add-item-modal');
            const confirmModal = document.getElementById('confirm-modal');
            
            // 出題者モードのステージ
            const dealerStage1 = document.getElementById('dealer-stage-1');
            const dealerStage2 = document.getElementById('dealer-stage-2');
            const dealerStage3 = document.getElementById('dealer-stage-3');
            const dealerServing = document.getElementById('dealer-serving');
            const instructionsCard = document.getElementById('instructions-card');
            const dealerResultsScreen = document.getElementById('dealer-results-screen');
            
            // 回答者モードのステージ
            const playerStage1 = document.getElementById('player-stage-1');
            const tastingProcess = document.getElementById('tasting-process');
            const finalAnswer = document.getElementById('final-answer');
            const playerResultsScreen = document.getElementById('player-results-screen');
            
            // エラー表示要素
            const itemError = document.getElementById('item-error');
            const guessError = document.getElementById('guess-error');
            const finalError = document.getElementById('final-error');
            
            // デフォルトのアイテムを設定
            initializeDefaultItems();
            
            // ストレージから保存済みのカスタムアイテムを読み込み
            loadCustomItems();
            
            // ホームボタンの表示・非表示を制御
            homeButton.style.display = 'none';
            
            // モードセレクターのボタン
            document.getElementById('dealer-button').addEventListener('click', function() {
                switchToMode('dealer');
            });
            
            document.getElementById('player-button').addEventListener('click', function() {
                switchToMode('player');
            });
            
            // ホームボタンの処理
            homeButton.addEventListener('click', function() {
                returnToHome();
            });
            
            // モード切り替え関数
            function switchToMode(mode) {
                gameMode = mode;
                homeScreen.style.display = 'none';
                homeButton.style.display = 'flex';
                
                if (mode === 'dealer') {
                    dealerSection.style.display = 'block';
                    playerSection.style.display = 'none';
                    dealerModeLabel.style.display = 'inline-block';
                    playerModeLabel.style.display = 'none';
                    addItemButton.style.display = 'flex';
                    resetDealerMode();
                } else if (mode === 'player') {
                    dealerSection.style.display = 'none';
                    playerSection.style.display = 'block';
                    playerModeLabel.style.display = 'inline-block';
                    dealerModeLabel.style.display = 'none';
                    addItemButton.style.display = 'none';
                    resetPlayerMode();
                }
            }
            
            // ホームに戻る
            function returnToHome() {
                homeScreen.style.display = 'block';
                dealerSection.style.display = 'none';
                playerSection.style.display = 'none';
                dealerModeLabel.style.display = 'none';
                playerModeLabel.style.display = 'none';
                homeButton.style.display = 'none';
                addItemButton.style.display = 'none';
                gameMode = '';
            }
            
            // 出題者モードのリセット
            function resetDealerMode() {
                dealerStage1.style.display = 'block';
                dealerStage2.style.display = 'none';
                dealerStage3.style.display = 'none';
                dealerServing.style.display = 'none';
                instructionsCard.style.display = 'none';
                dealerResultsScreen.style.display = 'none';
                
                // テーマに合わせたアイテム表示
                document.getElementById('test-name').value = getDefaultTestName();
                initializeItemSelection();
                
                selectedItems = [];
                dealerOrder = [];
                currentCup = 1;
                testResults = null;
            }
            
            // 回答者モードのリセット
            function resetPlayerMode() {
                playerStage1.style.display = 'block';
                tastingProcess.style.display = 'none';
                finalAnswer.style.display = 'none';
                playerResultsScreen.style.display = 'none';
                
                // テスト情報の表示
                document.getElementById('player-test-name').textContent = testName || getDefaultTestName();
                document.getElementById('player-item-count').textContent = totalCups || '?';
                
                playerProvisionalAnswers = [];
                playerFinalAnswers = [];
                currentCup = 1;
            }
            
            // デフォルトのテスト名を取得
            function getDefaultTestName() {
                switch(activeTheme) {
                    case 'water': return '水の利き比べ';
                    case 'wine': return 'ワインテイスティング';
                    case 'fruit': return 'フルーツ食べ比べ';
                    case 'coffee': return 'コーヒーテイスティング';
                    case 'custom': return 'カスタムテイスティング';
                    default: return 'テイスティングチャレンジ';
                }
            }
            
            // デフォルトのアイテムを設定
            function initializeDefaultItems() {
                // 水
                defaultItems.water = [
                    { name: '天然水', image: 'tennensui.png', category: 'water' },
                    { name: 'いろはす', image: 'irohasu.png', category: 'water' },
                    { name: 'クリスタルガイザー', image: 'crystal.png', category: 'water' },
                    { name: 'エビアン', image: 'ebian.png', category: 'water' },
                    { name: '富士山水', image: 'fujisansui.png', category: 'water' },
                    { name: 'おいしい水', image: 'oisiimizu.png', category: 'water' },
                    { name: 'アルカリ天然水', image: 'premiere.png', category: 'water' },
                    { name: 'ウォーターサーバー', image: 'server.png', category: 'water' }
                ];
                
                // ワイン
                defaultItems.wine = [
                    { name: 'カベルネ・ソーヴィニヨン', image: '/api/placeholder/400/400', category: 'wine' },
                    { name: 'メルロー', image: '/api/placeholder/400/400', category: 'wine' },
                    { name: 'ピノ・ノワール', image: '/api/placeholder/400/400', category: 'wine' },
                    { name: 'シャルドネ', image: '/api/placeholder/400/400', category: 'wine' },
                    { name: 'ソーヴィニヨン・ブラン', image: '/api/placeholder/400/400', category: 'wine' },
                    { name: 'リースリング', image: '/api/placeholder/400/400', category: 'wine' }
                ];
                
                // フルーツ
                defaultItems.fruit = [
                    { name: 'りんご', image: '/api/placeholder/400/400', category: 'fruit' },
                    { name: 'みかん', image: '/api/placeholder/400/400', category: 'fruit' },
                    { name: 'バナナ', image: '/api/placeholder/400/400', category: 'fruit' },
                    { name: 'ぶどう', image: '/api/placeholder/400/400', category: 'fruit' },
                    { name: 'いちご', image: '/api/placeholder/400/400', category: 'fruit' },
                    { name: 'キウイ', image: '/api/placeholder/400/400', category: 'fruit' }
                ];
                
                // コーヒー
                defaultItems.coffee = [
                    { name: 'ブラジル', image: '/api/placeholder/400/400', category: 'coffee' },
                    { name: 'コロンビア', image: '/api/placeholder/400/400', category: 'coffee' },
                    { name: 'エチオピア', image: '/api/placeholder/400/400', category: 'coffee' },
                    { name: 'グァテマラ', image: '/api/placeholder/400/400', category: 'coffee' },
                    { name: 'ケニア', image: '/api/placeholder/400/400', category: 'coffee' },
                    { name: 'ハワイ・コナ', image: '/api/placeholder/400/400', category: 'coffee' }
                ];
            }
            
            // カスタムアイテムをローカルストレージから読み込み
            function loadCustomItems() {
                const savedItems = localStorage.getItem('tasting-challenge-custom-items');
                if (savedItems) {
                    customItems = JSON.parse(savedItems);
                }
            }
            
            // カスタムアイテムをローカルストレージに保存
            function saveCustomItems() {
                localStorage.setItem('tasting-challenge-custom-items', JSON.stringify(customItems));
            }
            
            // エラー表示関数
            function showError(element, message) {
                element.textContent = message;
                element.style.display = 'block';
            }
            
            function hideError(element) {
                element.style.display = 'none';
            }
            
            // 通知表示関数
            function showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // アイテム選択の初期化
            function initializeItemSelection() {
                const itemSelection = document.getElementById('item-selection');
                itemSelection.innerHTML = '';
                
                // 選択されたテーマのデフォルトアイテムを表示
                const itemsToShow = defaultItems[activeTheme] || [];
                
                itemsToShow.forEach(item => {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" value="${item.name}" data-category="${item.category}">
                        <div class="item-img-container">
                            <img src="${item.image}" alt="${item.name}">
                        </div>
                        <div class="item-name">${item.name}</div>
                    `;
                    itemSelection.appendChild(label);
                });
                
                // カスタムアイテムを表示（選択されたカテゴリに合致するもの）
                customItems.filter(item => item.category === activeTheme || activeTheme === 'custom')
                    .forEach(item => {
                        const label = document.createElement('label');
                        label.innerHTML = `
                            <input type="checkbox" value="${item.name}" data-category="${item.category}">
                            <div class="item-img-container">
                                <img src="${item.image}" alt="${item.name}">
                            </div>
                            <div class="item-name">${item.name}</div>
                        `;
                        itemSelection.appendChild(label);
                    });
            }
            
            // テーマオプションのクリックイベント
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 以前のアクティブなテーマを削除
                    document.querySelector('.theme-option.active').classList.remove('active');
                    // 新しいテーマをアクティブに
                    this.classList.add('active');
                    // テーマを保存
                    activeTheme = this.getAttribute('data-theme');
                });
            });
            
            // 出題者ステージ1 -> ステージ2
            document.getElementById('next-to-order').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('#item-selection input[type="checkbox"]:checked');
                if (checkboxes.length <= 1) {
                    showError(itemError, '2つ以上のアイテムを選択してください。');
                    return;
                }
                hideError(itemError);
                
                // テスト名の取得
                testName = document.getElementById('test-name').value.trim() || getDefaultTestName();
                
                // 選択されたアイテムの取得
                selectedItems = Array.from(checkboxes).map(cb => {
                    return {
                        name: cb.value,
                        category: cb.getAttribute('data-category')
                    };
                });
                totalCups = selectedItems.length;
                
                // ステージ切り替え
                dealerStage1.style.display = 'none';
                dealerStage2.style.display = 'block';
                
                // 順序リストの初期化
                initializeOrderList();
            });
            
            // 順序リストの初期化
            function initializeOrderList() {
                const orderList = document.getElementById('order-list');
                orderList.innerHTML = '';
                
                selectedItems.forEach(item => {
                    const li = document.createElement('li');
                    li.setAttribute('data-value', item.name);
                    li.innerHTML = `
                        <img src="${getImageFile(item.name)}" alt="${item.name}">
                        <span>${item.name}</span>
                        <div class="handle"><i class="fas fa-grip-lines"></i></div>
                    `;
                    orderList.appendChild(li);
                });
                
                // Sortable.jsの初期化
                Sortable.create(orderList, {
                    animation: 150,
                    handle: '.handle',
                    ghostClass: 'sortable-ghost'
                });
            }
            
            // 出題者ステージ2 -> ステージ3
            document.getElementById('confirm-order').addEventListener('click', function() {
                const orderItems = document.querySelectorAll('#order-list li');
                dealerOrder = Array.from(orderItems).map(item => item.getAttribute('data-value'));
                
                // ステージ切り替え
                dealerStage2.style.display = 'none';
                dealerStage3.style.display = 'block';
                
                // テスト情報の表示
                document.getElementById('test-name-display').textContent = testName;
                document.getElementById('item-count').textContent = selectedItems.length;
            });
            
            // 手順書の生成と表示
            document.getElementById('generate-instructions').addEventListener('click', function() {
                // 手順書の内容を設定
                // アイテムリストの表示
                const itemList = document.getElementById('item-list');
                itemList.innerHTML = '';
                selectedItems.forEach(item => {
                    itemList.innerHTML += `<div>${item.name}</div>`;
                });
                
                // 提供順序の表示
                const servingOrder = document.getElementById('serving-order');
                servingOrder.innerHTML = '';
                dealerOrder.forEach((item, index) => {
                    servingOrder.innerHTML += `<div>${index + 1}杯目: ${item}</div>`;
                });
                
                // 手順書カードを表示
                dealerStage3.style.display = 'none';
                instructionsCard.style.display = 'block';
            });
            
            // 手順書の印刷
            document.getElementById('print-instructions').addEventListener('click', function() {
                window.print();
            });
            
            // 手順書から設定画面に戻る
            document.getElementById('back-to-setup').addEventListener('click', function() {
                instructionsCard.style.display = 'none';
                dealerStage3.style.display = 'block';
            });
            
            // テストを開始
            document.getElementById('start-test').addEventListener('click', function() {
                dealerStage3.style.display = 'none';
                dealerServing.style.display = 'block';
                
                // 最初のアイテムの表示
                showDealerItem();
            });
            
            // 次のアイテムへ
            document.getElementById('next-item').addEventListener('click', function() {
                currentCup++;
                
                if (currentCup > totalCups) {
                    // 全てのアイテムが終了したら役割を切り替える
                    showScreenCover('出題が完了しました', '回答者に最終回答を入力してもらってください。');
                    dealerServing.style.display = 'none';
                    screenCover.style.display = 'flex';
                } else {
                    // 次のアイテムを表示
                    showDealerItem();
                }
            });
            
            // 出題者のアイテム表示
            function showDealerItem() {
                const itemName = dealerOrder[currentCup - 1];
                document.getElementById('dealer-current-cup').textContent = currentCup;
                document.getElementById('dealer-item-name').textContent = itemName;
                document.getElementById('dealer-item-img').src = getImageFile(itemName);
                document.getElementById('dealer-item-img').alt = itemName;
            }
            
            // スクリーンカバーの表示
            function showScreenCover(title, message) {
                document.querySelector('.cover-title').textContent = title;
                document.querySelector('.cover-message').textContent = message;
                screenCover.style.display = 'flex';
            }
            
            // スクリーンカバーの続行ボタン
            document.getElementById('cover-continue').addEventListener('click', function() {
                screenCover.style.display = 'none';
                
                // 役割に応じた画面を表示
                if (gameMode === 'dealer') {
                    switchToMode('player');
                } else if (gameMode === 'player') {
                    // 最終回答後の結果表示へ
                    calculateResults();
                    showResults();
                }
            });
            
            // 回答者テストの開始
            document.getElementById('start-player-test').addEventListener('click', function() {
                playerStage1.style.display = 'none';
                tastingProcess.style.display = 'block';
                
                // テイスティングプロセスの開始
                startTastingProcess();
            });
            
            // テイスティングプロセスの開始
            function startTastingProcess() {
                // 現在の杯数を表示
                document.getElementById('current-cup-display').textContent = currentCup;
                
                // 選択肢を表示
                const playerItemSelection = document.getElementById('player-item-selection');
                playerItemSelection.innerHTML = '';
                
                selectedItems.forEach(item => {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <input type="checkbox" name="player-choice" value="${item.name}">
                        <div class="item-img-container">
                            <img src="${getImageFile(item.name)}" alt="${item.name}">
                        </div>
                        <div class="item-name">${item.name}</div>
                    `;
                    playerItemSelection.appendChild(label);
                });
            }
            
            // 仮回答の提出
            document.getElementById('submit-guess').addEventListener('click', function() {
                const checkedBoxes = document.querySelectorAll('#player-item-selection input[type="checkbox"]:checked');
                
                if (checkedBoxes.length === 0) {
                    showError(guessError, '少なくとも1つのアイテムを選択してください。');
                    return;
                }
                
                hideError(guessError);
                
                // 選択されたアイテムを記録
                const selectedOptions = Array.from(checkedBoxes).map(cb => cb.value);
                playerProvisionalAnswers.push({
                    cup: currentCup,
                    guesses: selectedOptions
                });
                
                // チェックをリセット
                checkedBoxes.forEach(cb => cb.checked = false);
                
                // 次の杯へ移動または最終回答へ
                currentCup++;
                
                if (currentCup <= totalCups) {
                    // 次の杯へ
                    document.getElementById('current-cup-display').textContent = currentCup;
                    showNotification(`${currentCup}杯目のアイテムを受け取ってください`);
                } else {
                    // 全ての杯が終了
                    tastingProcess.style.display = 'none';
                    prepareFinalAnswer();
                }
            });
            
            // 最終回答の準備
            function prepareFinalAnswer() {
                finalAnswer.style.display = 'block';
                
                // 途中回答の表示
                const provisionalAnswers = document.getElementById('provisional-answers');
                provisionalAnswers.innerHTML = '<h3>途中回答の記録</h3>';
                
                playerProvisionalAnswers.forEach(answer => {
                    const answerElement = document.createElement('div');
                    answerElement.className = 'provisional-answer';
                    answerElement.innerHTML = `
                        <strong>${answer.cup}杯目:</strong> ${answer.guesses.join('、')}
                    `;
                    provisionalAnswers.appendChild(answerElement);
                });
                
                // 最終回答フォームの準備
                const finalAnswerForm = document.getElementById('final-answer-form');
                finalAnswerForm.innerHTML = '<h3>最終回答</h3>';
                
                for (let i = 1; i <= totalCups; i++) {
                    const cupForm = document.createElement('div');
                    cupForm.className = 'cup-form';
                    cupForm.innerHTML = `<h4>${i}杯目</h4>`;
                    
                    const selectElement = document.createElement('select');
                    selectElement.className = 'final-select';
                    selectElement.setAttribute('data-cup', i);
                    
                    // 空のオプションを追加
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = '選択してください';
                    selectElement.appendChild(emptyOption);
                    
                    // アイテムの選択肢を追加
                    selectedItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.textContent = item.name;
                        selectElement.appendChild(option);
                    });
                    
                    cupForm.appendChild(selectElement);
                    finalAnswerForm.appendChild(cupForm);
                }
            }
            
            // 最終回答の提出
            document.getElementById('submit-final').addEventListener('click', function() {
                const selects = document.querySelectorAll('.final-select');
                
                // すべて選択されているか確認
                let allSelected = true;
                selects.forEach(select => {
                    if (!select.value) {
                        allSelected = false;
                    }
                });
                
                if (!allSelected) {
                    showError(finalError, 'すべての杯についてアイテムを選択してください。');
                    return;
                }
                
                hideError(finalError);
                
                // 最終回答の記録
                playerFinalAnswers = Array.from(selects).map(select => ({
                    cup: parseInt(select.getAttribute('data-cup')),
                    answer: select.value
                })).sort((a, b) => a.cup - b.cup);
                
                // 出題者に切り替え（結果確認）
                showScreenCover('回答が完了しました', '出題者に結果を確認してもらいましょう。');
                finalAnswer.style.display = 'none';
                screenCover.style.display = 'flex';
            });
            
            // 結果の計算
            function calculateResults() {
                let correctCount = 0;
                const results = [];
                
                for (let i = 0; i < totalCups; i++) {
                    const playerAnswer = playerFinalAnswers[i].answer;
                    const correctAnswer = dealerOrder[i];
                    const isCorrect = playerAnswer === correctAnswer;
                    
                    if (isCorrect) {
                        correctCount++;
                    }
                    
                    results.push({
                        cup: i + 1,
                        playerAnswer: playerAnswer,
                        correctAnswer: correctAnswer,
                        isCorrect: isCorrect
                    });
                }
                
                const accuracy = (correctCount / totalCups) * 100;
                
                testResults = {
                    totalCups: totalCups,
                    correctCount: correctCount,
                    accuracy: accuracy,
                    details: results
                };
            }
            
            // 結果の表示
            function showResults() {
                if (gameMode === 'dealer') {
                    dealerResultsScreen.style.display = 'block';
                    
                    // 結果の表示
                    document.getElementById('correct-count').textContent = testResults.correctCount;
                    document.getElementById('total-count').textContent = testResults.totalCups;
                    document.getElementById('accuracy-percent').textContent = `${testResults.accuracy.toFixed(1)}%`;
                    
                    // 星評価の表示
                    const ratingStars = document.getElementById('rating-stars');
                    ratingStars.innerHTML = generateStarRating(testResults.accuracy);
                    
                    // 詳細結果の表示
                    displayDetailedResults('dealer-results', 'player-results');
                } else if (gameMode === 'player') {
                    playerResultsScreen.style.display = 'block';
                    
                    // 結果の表示
                    document.getElementById('player-correct-count').textContent = testResults.correctCount;
                    document.getElementById('player-total-count').textContent = testResults.totalCups;
                    document.getElementById('player-accuracy-percent').textContent = `${testResults.accuracy.toFixed(1)}%`;
                    
                    // 星評価の表示
                    const ratingStars = document.getElementById('player-rating-stars');
                    ratingStars.innerHTML = generateStarRating(testResults.accuracy);
                    
                    // 詳細結果の表示
                    displayDetailedResults('correct-answers', 'your-answers');
                }
            }
            
            // 詳細結果の表示
            function displayDetailedResults(correctContainerId, playerContainerId) {
                const correctContainer = document.getElementById(correctContainerId);
                const playerContainer = document.getElementById(playerContainerId);
                
                correctContainer.innerHTML = '';
                playerContainer.innerHTML = '';
                
                testResults.details.forEach(detail => {
                    // 正解の表示
                    const correctItem = document.createElement('div');
                    correctItem.className = 'comparison-item';
                    correctItem.innerHTML = `
                        <img src="${getImageFile(detail.correctAnswer)}" alt="${detail.correctAnswer}">
                        <div class="comparison-item-text">
                            <div class="cup-number-small">${detail.cup}杯目</div>
                            <div class="item-title">${detail.correctAnswer}</div>
                        </div>
                    `;
                    correctContainer.appendChild(correctItem);
                    
                    // 回答者の回答表示
                    const playerItem = document.createElement('div');
                    playerItem.className = detail.isCorrect ? 'comparison-item correct' : 'comparison-item incorrect';
                    playerItem.innerHTML = `
                        <img src="${getImageFile(detail.playerAnswer)}" alt="${detail.playerAnswer}">
                        <div class="comparison-item-text">
                            <div class="cup-number-small">${detail.cup}杯目</div>
                            <div class="item-title">${detail.playerAnswer}</div>
                            ${detail.isCorrect ? 
                                '<div><i class="fas fa-check" style="color: #4CAF50;"></i> 正解</div>' : 
                                '<div><i class="fas fa-times" style="color: #F44336;"></i> 不正解</div>'}
                        </div>
                    `;
                    playerContainer.appendChild(playerItem);
                });
            }
            
            // 星評価の生成
            function generateStarRating(accuracy) {
                let stars = '';
                const rating = Math.round(accuracy / 20); // 100%を5つ星にスケール
                
                for (let i = 0; i < 5; i++) {
                    if (i < rating) {
                        stars += '<i class="fas fa-star"></i>';
                    } else {
                        stars += '<i class="far fa-star"></i>';
                    }
                }
                
                return stars;
            }
            
            // 新しいテストを作成
            document.getElementById('new-test').addEventListener('click', function() {
                resetDealerMode();
                dealerResultsScreen.style.display = 'none';
            });
            
            // ホームに戻る
            document.getElementById('go-home').addEventListener('click', function() {
                returnToHome();
            });
            
            // もう一度チャレンジ
            document.getElementById('try-again').addEventListener('click', function() {
                resetPlayerMode();
                playerResultsScreen.style.display = 'none';
            });
            
            // 回答者がホームに戻る
            document.getElementById('player-go-home').addEventListener('click', function() {
                returnToHome();
            });
            
            // 画像ファイルの取得
            function getImageFile(itemName) {
                // カスタムアイテムの画像をチェック
                const customItem = customItems.find(item => item.name === itemName);
                if (customItem) {
                    return customItem.image;
                }
                
                // デフォルトのアイテムをチェック
                for (const category in defaultItems) {
                    const item = defaultItems[category].find(item => item.name === itemName);
                    if (item) {
                        return item.image;
                    }
                }
                
                // 見つからない場合はプレースホルダー
                return '/api/placeholder/400/400';
            }
            
            // 追加ボタンのイベントリスナー
            document.getElementById('add-item-button').addEventListener('click', function() {
                // モーダルをリセット
                document.getElementById('item-name').value = '';
                document.getElementById('item-image').value = '';
                document.getElementById('image-preview').style.display = 'none';
                document.getElementById('item-category').value = activeTheme;
                
                // モーダルを表示
                addItemModal.style.display = 'flex';
            });
            
            // モーダルをキャンセル
            document.getElementById('cancel-add').addEventListener('click', function() {
                addItemModal.style.display = 'none';
            });
            
            // モーダルの外側をクリックしたら閉じる
            addItemModal.addEventListener('click', function(e) {
                if (e.target === addItemModal) {
                    addItemModal.style.display = 'none';
                }
            });
            
            // 画像ファイル選択時のプレビュー
            document.getElementById('item-image').addEventListener('change', function(e) {
                const file = this.files[0];
                if (file && file.type.match('image.*')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('preview-img').src = e.target.result;
                        document.getElementById('image-preview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // 新しいアイテムを追加
            document.getElementById('confirm-add').addEventListener('click', function() {
                const itemName = document.getElementById('item-name').value.trim();
                const itemCategory = document.getElementById('item-category').value;
                const itemImage = document.getElementById('item-image').files[0];
                
                if (!itemName) {
                    alert('アイテム名を入力してください。');
                    return;
                }
                
                // 既存のアイテムと同じ名前でないかチェック
                if (isItemNameExists(itemName)) {
                    alert('既に同じ名前のアイテムが存在します。別の名前を入力してください。');
                    return;
                }
                
                // 画像の処理
                if (itemImage) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addNewItem(itemName, e.target.result, itemCategory);
                        addItemModal.style.display = 'none';
                    };
                    reader.readAsDataURL(itemImage);
                } else {
                    // 画像がない場合はプレースホルダー画像を使用
                    addNewItem(itemName, '/api/placeholder/400/400', itemCategory);
                    addItemModal.style.display = 'none';
                }
            });
            
            // アイテム名が既に存在するかチェック
            function isItemNameExists(name) {
                // カスタムアイテム内でチェック
                if (customItems.some(item => item.name === name)) {
                    return true;
                }
                
                // デフォルトアイテム内でチェック
                for (const category in defaultItems) {
                    if (defaultItems[category].some(item => item.name === name)) {
                        return true;
                    }
                }
                
                return false;
            }
            
        function addNewItem(name, imageUrl, category) {
    // カスタムアイテムのリストに追加
    const newItem = {
        name: name,
        image: imageUrl,
        category: category
    };
    
    customItems.push(newItem);
    
    // ローカルストレージに保存
    saveCustomItems();
    
    // 現在のアイテム選択画面に追加（出題者モードの場合）
    if (gameMode === 'dealer' && dealerStage1.style.display === 'block') {
        const itemSelection = document.getElementById('item-selection');
        const label = document.createElement('label');
        label.innerHTML = `
            <input type="checkbox" value="${name}" data-category="${category}">
            <div class="item-img-container">
                <img src="${imageUrl}" alt="${name}">
            </div>
            <div class="item-name">${name}</div>
        `;
        itemSelection.appendChild(label);
    }
    
    showNotification(`${name} を追加しました`);
}

// 保存データのリセット
document.getElementById('reset-data').addEventListener('click', function() {
    // 確認ダイアログの表示
    document.getElementById('confirm-message').textContent = 'すべてのカスタムアイテムを削除しますか？この操作は元に戻せません。';
    confirmModal.style.display = 'flex';
    
    // 確認ボタンのイベントを設定
    document.getElementById('proceed-confirm').onclick = function() {
        // カスタムアイテムをクリア
        customItems = [];
        // ストレージからも削除
        localStorage.removeItem('tasting-challenge-custom-items');
        // 現在のアイテム選択画面を更新
        if (gameMode === 'dealer') {
            initializeItemSelection();
        }
        
        confirmModal.style.display = 'none';
        showNotification('保存データをリセットしました');
    };
});

// 確認ダイアログのキャンセル
document.getElementById('cancel-confirm').addEventListener('click', function() {
    confirmModal.style.display = 'none';
});

// 確認ダイアログの外側をクリックしたら閉じる
confirmModal.addEventListener('click', function(e) {
    if (e.target === confirmModal) {
        confirmModal.style.display = 'none';
    }
});

// ドラッグ&ドロップのサポート
const fileUpload = document.querySelector('.file-upload');
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    fileUpload.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    fileUpload.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    fileUpload.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    fileUpload.style.borderColor = 'var(--primary-color)';
    fileUpload.style.backgroundColor = 'rgba(33, 150, 243, 0.1)';
}

function unhighlight() {
    fileUpload.style.borderColor = '#e0e0e0';
    fileUpload.style.backgroundColor = '#f9f9f9';
}

fileUpload.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length) {
        document.getElementById('item-image').files = files;
        // ファイル選択イベントを発火
        const event = new Event('change', { bubbles: true });
        document.getElementById('item-image').dispatchEvent(event);
    }
}

// アコーディオンの動作
const accordionHeaders = document.querySelectorAll('.accordion-header');
accordionHeaders.forEach(header => {
    header.addEventListener('click', function() {
        const content = this.nextElementSibling;
        content.classList.toggle('show');
        
        // アイコンの回転
        const icon = this.querySelector('i');
        if (content.classList.contains('show')) {
            icon.style.transform = 'rotate(180deg)';
        } else {
            icon.style.transform = 'rotate(0)';
        }
    });
});
             </script>
</body>
</html>
