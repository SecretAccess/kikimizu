<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>目隠しテイスティングゲーム</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .item-card {
            transition: all 0.3s ease;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .role-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        .option-card {
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        .option-card.selected {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .option-card:hover:not(.selected) {
            border-color: #a0aec0;
        }
        .dragging {
            opacity: 0.5;
            background-color: #e2e8f0;
        }
        .drag-over {
            border-top: 2px solid #4299e1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="p-4 container mx-auto">
        <!-- Content will be rendered by JavaScript -->
    </div>

    <script>
        // Game state management
        const state = {
            items: [],
            gameMode: 'setup', // 'setup', 'dealerChooseOrder', 'dealerShow', 'playerGuess', 'playerArrange', 'results'
            currentItemIndex: 0,
            servingOrder: [],
            playerGuesses: [],
            currentRole: 'none', // 'dealer', 'player', 'none'
            itemBeingDragged: null,
            draggedItemIndex: null
        };

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadItems();
            renderApp();
        });

        // Load items from localStorage
        function loadItems() {
            const storedItems = localStorage.getItem('tastingItems');
            if (storedItems) {
                state.items = JSON.parse(storedItems);
            }
        }

        // Save items to localStorage
        function saveItems() {
            localStorage.setItem('tastingItems', JSON.stringify(state.items));
        }

        // Show a toast message
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white font-medium shadow-lg z-50 fade-in ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.style.transition = 'opacity 0.5s ease';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // Main render function
        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            // Role badge (always visible)
            if (state.currentRole !== 'none') {
                const roleBadge = document.createElement('div');
                roleBadge.className = 'role-badge bg-gray-800 text-white px-3 py-1 rounded-full text-sm flex items-center';
                roleBadge.innerHTML = `<i class="fas ${state.currentRole === 'dealer' ? 'fa-user-tie' : 'fa-user'} mr-2"></i>
                    ${state.currentRole === 'dealer' ? 'ディーラー' : 'プレイヤー'}`;
                app.appendChild(roleBadge);
            }

            // Render different views based on game mode
            switch (state.gameMode) {
                case 'setup':
                    renderSetupScreen(app);
                    break;
                case 'dealerChooseOrder':
                    renderDealerScreen(app);
                    break;
                case 'dealerShow':
                    renderDealerShowScreen(app);
                    break;
                case 'playerGuess':
                    renderPlayerGuessScreen(app);
                    break;
                case 'playerArrange':
                    renderPlayerArrangeScreen(app);
                    break;
                case 'results':
                    renderResultsScreen(app);
                    break;
                default:
                    renderSetupScreen(app);
            }
        }

        // Setup screen: Add items and start game
        function renderSetupScreen(app) {
            // Header
            const header = document.createElement('div');
            header.className = 'text-center mb-8 mt-4';
            header.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-2">目隠しテイスティングゲーム</h1>
                <p class="text-gray-600">味を当てるゲーム</p>
            `;
            app.appendChild(header);

            // Items list container
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'mb-8';
            
            // Items header
            const itemsHeader = document.createElement('div');
            itemsHeader.className = 'flex justify-between items-center mb-4';
            itemsHeader.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-700">テイスティングアイテム</h2>
                <button id="resetItems" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                    リセット
                </button>
            `;
            itemsContainer.appendChild(itemsHeader);

            // Items grid
            const itemsGrid = document.createElement('div');
            itemsGrid.className = 'grid grid-cols-2 gap-4 mb-6';
            
            // Render each item
            state.items.forEach((item, index) => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card bg-white rounded-lg shadow p-4 flex flex-col';
                
                // Item image or placeholder
                let imageHtml = '';
                if (item.image) {
                    imageHtml = `<img src="${item.image}" alt="${item.name}" class="w-full h-32 object-cover rounded mb-3">`;
                } else {
                    imageHtml = `<div class="w-full h-32 bg-gray-200 rounded flex items-center justify-center mb-3">
                        <i class="fas fa-image text-gray-400 text-2xl"></i>
                    </div>`;
                }
                
                itemCard.innerHTML = `
                    ${imageHtml}
                    <h3 class="text-lg font-medium text-gray-800 mb-2">${item.name}</h3>
                    <div class="mt-auto flex justify-end">
                        <button class="delete-item text-red-500 hover:text-red-700" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                itemsGrid.appendChild(itemCard);
            });

            // Add new item card
            const newItemCard = document.createElement('div');
            newItemCard.className = 'item-card bg-white rounded-lg shadow p-4 flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-gray-300 hover:border-blue-500';
            newItemCard.id = 'addNewItem';
            newItemCard.innerHTML = `
                <i class="fas fa-plus text-gray-400 text-2xl mb-2"></i>
                <p class="text-gray-600">新しいアイテムを追加</p>
            `;
            itemsGrid.appendChild(newItemCard);
            
            itemsContainer.appendChild(itemsGrid);
            app.appendChild(itemsContainer);

            // Start game button (enabled only if there are at least 2 items)
            const startGameBtn = document.createElement('button');
            startGameBtn.className = `w-full py-3 rounded-lg text-white font-medium text-lg transition-colors ${state.items.length >= 2 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'}`;
            startGameBtn.textContent = 'ゲームを始める';
            startGameBtn.disabled = state.items.length < 2;
            app.appendChild(startGameBtn);

            // Event handlers
            startGameBtn.addEventListener('click', () => {
                if (state.items.length >= 2) {
                    state.gameMode = 'dealerChooseOrder';
                    state.currentRole = 'dealer';
                    state.servingOrder = [...Array(state.items.length).keys()]; // Default order is the same as item list
                    renderApp();
                }
            });

            document.getElementById('addNewItem').addEventListener('click', () => {
                showAddItemModal();
            });

            document.getElementById('resetItems').addEventListener('click', () => {
                if (confirm('本当にすべてのアイテムをリセットしますか？')) {
                    state.items = [];
                    saveItems();
                    renderApp();
                }
            });

            // Add delete item event handlers
            document.querySelectorAll('.delete-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.currentTarget.dataset.index);
                    state.items.splice(index, 1);
                    saveItems();
                    renderApp();
                });
            });
        }

        // Add new item modal
        function showAddItemModal() {
            // Remove any existing modal first
            const existingModal = document.getElementById('addItemModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'overlay fade-in';
            modalOverlay.id = 'addItemModal';
            
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-lg w-11/12 max-w-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">新しいアイテムを追加</h3>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="itemName">
                            アイテム名
                        </label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="itemName" type="text" placeholder="アイテム名を入力">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            画像 (オプション)
                        </label>
                        <div class="flex items-center">
                            <label class="w-full flex flex-col items-center px-4 py-6 bg-white text-blue-500 rounded-lg shadow-lg tracking-wide uppercase border border-blue-500 cursor-pointer hover:bg-blue-500 hover:text-white">
                                <i class="fas fa-cloud-upload-alt text-xl"></i>
                                <span class="mt-2 text-sm leading-normal">画像を選択</span>
                                <input type='file' class="hidden" id="itemImage" accept="image/*" />
                            </label>
                        </div>
                        <div id="imagePreview" class="mt-3 hidden">
                            <img id="preview" class="max-h-32 rounded" />
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <button id="cancelAddItem" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                            キャンセル
                        </button>
                        <button id="saveNewItem" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                            保存
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Preview image when selected
            document.getElementById('itemImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('preview');
                        preview.src = e.target.result;
                        document.getElementById('imagePreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Close modal handlers
            document.getElementById('closeModal').addEventListener('click', () => {
                modalOverlay.remove();
            });
            
            document.getElementById('cancelAddItem').addEventListener('click', () => {
                modalOverlay.remove();
            });
            
            // Save button
            document.getElementById('saveNewItem').addEventListener('click', () => {
                const name = document.getElementById('itemName').value.trim();
                if (name) {
                    const imagePreview = document.getElementById('preview');
                    const newItem = {
                        name: name,
                        image: imagePreview ? imagePreview.src : ''
                    };
                    
                    state.items.push(newItem);
                    saveItems();
                    modalOverlay.remove();
                    showToast(`${name}を追加しました`, 'success');
                    renderApp();
                } else {
                    alert('アイテム名を入力してください');
                }
            });
        }

        // Dealer screen: Choose serving order
        function renderDealerScreen(app) {
            // Role confirmation modal
            if (state.currentRole !== 'dealer') {
                renderRoleConfirmation(app, 'dealer');
                return;
            }

            const header = document.createElement('div');
            header.className = 'text-center mb-8';
            header.innerHTML = `
                <h1 class="text-2xl font-bold text-gray-800 mb-2">提供順序を決める</h1>
                <p class="text-gray-600">アイテムをドラッグして提供順序を変更できます</p>
            `;
            app.appendChild(header);

            // Items list for reordering
            const itemsList = document.createElement('div');
            itemsList.className = 'bg-white rounded-lg shadow mb-8';
            itemsList.id = 'reorderableList';
            
            state.servingOrder.forEach((itemIndex, orderIndex) => {
                const item = state.items[itemIndex];
                const itemRow = document.createElement('div');
                itemRow.className = 'p-4 border-b last:border-b-0 flex items-center';
                itemRow.setAttribute('draggable', 'true');
                itemRow.dataset.orderIndex = orderIndex;
                itemRow.dataset.itemIndex = itemIndex;
                
                // Item image or placeholder
                let imageHtml = '';
                if (item.image) {
                    imageHtml = `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded mr-4">`;
                } else {
                    imageHtml = `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center mr-4">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>`;
                }
                
                itemRow.innerHTML = `
                    <div class="drag-handle mr-3 text-gray-400">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    ${imageHtml}
                    <div>
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-500">提供順序: ${orderIndex + 1}</p>
                    </div>
                `;
                
                // Drag and drop event listeners
                itemRow.addEventListener('dragstart', handleDragStart);
                itemRow.addEventListener('dragend', handleDragEnd);
                itemRow.addEventListener('dragover', handleDragOver);
                itemRow.addEventListener('dragleave', handleDragLeave);
                itemRow.addEventListener('drop', handleDrop);
                
                itemsList.appendChild(itemRow);
            });
            
            app.appendChild(itemsList);

            // Start serving button
            const startServingBtn = document.createElement('button');
            startServingBtn.className = 'w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium text-lg transition-colors';
            startServingBtn.textContent = 'テイスティングを始める';
            startServingBtn.addEventListener('click', () => {
                state.gameMode = 'dealerShow';
                state.currentItemIndex = 0;
                state.playerGuesses = new Array(state.servingOrder.length).fill(-1); // Initialize with -1 (no selection)
                renderApp();
            });
            app.appendChild(startServingBtn);
            
            // Back button
            const backButton = document.createElement('button');
            backButton.className = 'mt-4 w-full py-2 text-gray-600 hover:text-gray-800';
            backButton.innerHTML = '<i class="fas fa-arrow-left mr-2"></i> 戻る';
            backButton.addEventListener('click', () => {
                state.gameMode = 'setup';
                state.currentRole = 'none';
                renderApp();
            });
            app.appendChild(backButton);
        }

        // Drag and drop handlers
        function handleDragStart(e) {
            this.classList.add('dragging');
            state.draggedItemIndex = parseInt(this.dataset.orderIndex);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.orderIndex);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            // Remove drag-over class from all items
            document.querySelectorAll('.drag-over').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            this.classList.remove('drag-over');
            
            const draggedIndex = state.draggedItemIndex;
            const dropIndex = parseInt(this.dataset.orderIndex);
            
            if (draggedIndex !== dropIndex) {
                // Get the current mode to determine which array to update
                let arrayToUpdate;
                if (state.gameMode === 'dealerChooseOrder') {
                    arrayToUpdate = state.servingOrder;
                } else if (state.gameMode === 'playerArrange') {
                    arrayToUpdate = state.playerArrangeOrder;
                } else {
                    return; // Not in a reordering mode
                }
                
                // Perform the reordering
                const draggedItem = arrayToUpdate[draggedIndex];
                arrayToUpdate.splice(draggedIndex, 1);
                arrayToUpdate.splice(dropIndex, 0, draggedItem);
                
                // Render the updated UI
                renderApp();
            }
            
            return false;
        }

        // Warning popup when switching from player to dealer
        function showPlayerToDealerWarning(callback) {
            const warningOverlay = document.createElement('div');
            warningOverlay.className = 'overlay fade-in';
            warningOverlay.innerHTML = `
                <div class="bg-white rounded-lg w-11/12 max-w-md p-6 text-center">
                    <div class="text-red-500 text-5xl mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-4">注意！</h3>
                    <p class="mb-6">これからディーラー画面に切り替わります。ネタバレになるので、プレイヤーは画面を見ないでください。</p>
                    <div class="flex justify-center">
                        <button id="confirmSwitchRole" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">
                            確認して続ける
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(warningOverlay);
            
            document.getElementById('confirmSwitchRole').addEventListener('click', () => {
                warningOverlay.remove();
                if (callback) callback();
            });
        }

        // Dealer show screen: Show which item to serve
        function renderDealerShowScreen(app) {
            // Role confirmation modal
            if (state.currentRole !== 'dealer') {
                renderRoleConfirmation(app, 'dealer');
                return;
            }

            const currentItemIndex = state.servingOrder[state.currentItemIndex];
            const currentItem = state.items[currentItemIndex];
            
            const header = document.createElement('div');
            header.className = 'text-center mb-4';
            header.innerHTML = `
                <h1 class="text-2xl font-bold text-gray-800 mb-2">提供するアイテム</h1>
                <p class="text-gray-600">${state.currentItemIndex + 1}番目 / ${state.servingOrder.length}個</p>
            `;
            app.appendChild(header);
            
            // Item display
            const itemCard = document.createElement('div');
            itemCard.className = 'bg-white rounded-lg shadow-lg p-6 mb-8 fade-in';
            
            // Item image or placeholder
            let imageHtml = '';
            if (currentItem.image) {
                imageHtml = `<img src="${currentItem.image}" alt="${currentItem.name}" class="w-full h-48 object-contain rounded mb-4">`;
            } else {
                imageHtml = `<div class="w-full h-48 bg-gray-200 rounded flex items-center justify-center mb-4">
                    <i class="fas fa-image text-gray-400 text-4xl"></i>
                </div>`;
            }
            
            itemCard.innerHTML = `
                ${imageHtml}
                <h2 class="text-2xl font-bold text-center mb-2">${currentItem.name}</h2>
                <p class="text-center text-gray-600 mb-4">このアイテムをプレイヤーに提供してください</p>
                <div class="border-t border-gray-200 my-4 pt-4">
                    <p class="text-red-600 font-medium text-center">※プレイヤーには画面を見せないでください</p>
                </div>
            `;
            app.appendChild(itemCard);
            
            // Navigation buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mb-8';
            
            // Player guess button
            const playerGuessBtn = document.createElement('button');
            playerGuessBtn.className = 'w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium text-lg transition-colors';
            playerGuessBtn.textContent = 'プレイヤーに予想させる';
            playerGuessBtn.addEventListener('click', () => {
                state.gameMode = 'playerGuess';
                state.currentRole = 'player';
                renderApp();
            });
            buttonContainer.appendChild(playerGuessBtn);
            
            app.appendChild(buttonContainer);
            
            // Progress indicator
            const progressContainer = document.createElement('div');
            progressContainer.className = 'mt-4';
            progressContainer.innerHTML = `
                <div class="flex justify-between mb-2 text-sm">
                    <span>進捗</span>
                    <span>${state.currentItemIndex + 1} / ${state.servingOrder.length}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${((state.currentItemIndex + 1) / state.servingOrder.length) * 100}%"></div>
                </div>
            `;
            app.appendChild(progressContainer);
        }

        // Player guess screen: Let player guess what they tasted
        function renderPlayerGuessScreen(app) {
            // Role confirmation modal
            if (state.currentRole !== 'player') {
                renderRoleConfirmation(app, 'player');
                return;
            }

            const header = document.createElement('div');
            header.className = 'text-center mb-6';
            header.innerHTML = `
                <h1 class="text-2xl font-bold text-gray-800 mb-2">テイスティング予想</h1>
                <p class="text-gray-600">${state.currentItemIndex + 1}番目のアイテム</p>
            `;
            app.appendChild(header);
            
            // Guess form with item selection instead of free text
            const guessForm = document.createElement('div');
            guessForm.className = 'bg-white rounded-lg shadow p-6 mb-8';
            
            // Question header
            const questionHeader = document.createElement('div');
            questionHeader.className = 'mb-4';
            questionHeader.innerHTML = `
                <p class="font-medium text-lg mb-2">何を味わったと思いますか？</p>
                <p class="text-sm text-gray-500">下のオプションから選択してください</p>
            `;
            guessForm.appendChild(questionHeader);
            
            // Options grid
            const optionsGrid = document.createElement('div');
            optionsGrid.className = 'grid grid-cols-2 gap-3 mb-2';
            
            // Create an option for each item
            state.items.forEach((item, index) => {
                const isSelected = state.playerGuesses[state.currentItemIndex] === index;
                
                const optionCard = document.createElement('div');
                optionCard.className = `option-card p-3 rounded-lg border-2 ${isSelected ? 'selected border-blue-500 bg-blue-50' : 'border-gray-200'}`;
                optionCard.dataset.index = index;
                
                // Item image or placeholder
                let imageHtml = '';
                if (item.image) {
                    imageHtml = `<img src="${item.image}" alt="${item.name}" class="w-full h-20 object-cover rounded mb-2">`;
                } else {
                    imageHtml = `<div class="w-full h-20 bg-gray-200 rounded flex items-center justify-center mb-2">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>`;
                }
                
                optionCard.innerHTML = `
                    ${imageHtml}
                    <p class="font-medium text-center">${item.name}</p>
                    ${isSelected ? '<div class="absolute top-2 right-2 text-blue-500"><i class="fas fa-check-circle"></i></div>' : ''}
                `;
                
                // Click handler
                optionCard.addEventListener('click', () => {
                    state.playerGuesses[state.currentItemIndex] = index;
                    renderApp();
                });
                
                optionsGrid.appendChild(optionCard);
            });
            
            guessForm.appendChild(optionsGrid);
            app.appendChild(guessForm);
            
            // Check if player has selected an item
            const hasSelection = state.playerGuesses[state.currentItemIndex] !== -1;
            
            // Save and continue button
            const saveBtn = document.createElement('button');
            saveBtn.className = `w-full py-3 rounded-lg text-white font-medium text-lg transition-colors ${hasSelection ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'}`;
            saveBtn.disabled = !hasSelection;
            saveBtn.innerHTML = state.currentItemIndex + 1 < state.servingOrder.length ? '保存して次へ' : '保存して結果へ';
            
            saveBtn.addEventListener('click', () => {
                if (hasSelection) {
                    if (state.currentItemIndex + 1 < state.servingOrder.length) {
                        // Move to next item
                        state.currentItemIndex++;
                        
                        // Show warning when switching back to dealer
                        showPlayerToDealerWarning(() => {
                            state.gameMode = 'dealerShow';
                            state.currentRole = 'dealer';
                            renderApp();
                        });
                    } else {
                        // All items tasted, move to arrangement
                        state.gameMode = 'playerArrange';
                        renderApp();
                    }
                }
            });
            app.appendChild(saveBtn);
            
            // Progress indicator
            const progressContainer = document.createElement('div');
            progressContainer.className = 'mt-8';
            progressContainer.innerHTML = `
                <div class="flex justify-between mb-2 text-sm">
                    <span>進捗</span>
                    <span>${state.currentItemIndex + 1} / ${state.servingOrder.length}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${((state.currentItemIndex + 1) / state.servingOrder.length) * 100}%"></div>
                </div>
            `;
            app.appendChild(progressContainer);
        }

        // Player arrange screen: Let player arrange items in the order they think they tasted them
        function renderPlayerArrangeScreen(app) {
            // Role confirmation modal
            if (state.currentRole !== 'player') {
                renderRoleConfirmation(app, 'player');
                return;
            }

            const header = document.createElement('div');
            header.className = 'text-center mb-6';
            header.innerHTML = `
                <h1 class="text-2xl font-bold text-gray-800 mb-2">最終予想</h1>
                <p class="text-gray-600">テイスティングした順番に並べてください</p>
            `;
            app.appendChild(header);
            
            // Create player's guess order if not already created
            if (!state.playerArrangeOrder) {
                // Initialize with indices of the items in the order the player guessed them
                state.playerArrangeOrder = state.playerGuesses.slice();
            }
            
            // Instructions
            const instructions = document.createElement('div');
            instructions.className = 'mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
            instructions.innerHTML = `
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    アイテムをドラッグして、テイスティングされた順番に並べてください。
                </p>
            `;
            app.appendChild(instructions);
            
            // Items list for reordering
            const itemsList = document.createElement('div');
            itemsList.className = 'bg-white rounded-lg shadow mb-8';
            itemsList.id = 'reorderableList';
            
            state.playerArrangeOrder.forEach((itemIndex, orderIndex) => {
                const item = state.items[itemIndex];
                
                const itemRow = document.createElement('div');
                itemRow.className = 'p-4 border-b last:border-b-0 flex items-center';
                itemRow.setAttribute('draggable', 'true');
                itemRow.dataset.orderIndex = orderIndex;
                itemRow.dataset.itemIndex = itemIndex;
                
                // Item image or placeholder
                let imageHtml = '';
                if (item.image) {
                    imageHtml = `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded mr-4">`;
                } else {
                    imageHtml = `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center mr-4">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>`;
                }
                
                itemRow.innerHTML = `
                    <div class="drag-handle mr-3 text-gray-400">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    ${imageHtml}
                    <div class="flex-grow">
                        <p class="font-medium">${item.name}</p>
                    </div>
                    <div class="text-lg font-medium text-gray-800 flex items-center bg-gray-100 w-8 h-8 rounded-full justify-center">
                        ${orderIndex + 1}
                    </div>
                `;
                
                // Drag and drop event listeners
                itemRow.addEventListener('dragstart', handleDragStart);
                itemRow.addEventListener('dragend', handleDragEnd);
                itemRow.addEventListener('dragover', handleDragOver);
                itemRow.addEventListener('dragleave', handleDragLeave);
                itemRow.addEventListener('drop', handleDrop);
                
                itemsList.appendChild(itemRow);
            });
            
            app.appendChild(itemsList);
            
            // Show results button
            const showResultsBtn = document.createElement('button');
            showResultsBtn.className = 'w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium text-lg transition-colors';
            showResultsBtn.textContent = '結果を確認する';
            showResultsBtn.addEventListener('click', () => {
                state.gameMode = 'results';
                state.currentRole = 'none';
                renderApp();
            });
            app.appendChild(showResultsBtn);
        }

        // Results screen: Show the results
        function renderResultsScreen(app) {
            const header = document.createElement('div');
            header.className = 'text-center mb-6';
            header.innerHTML = `
                <h1 class="text-2xl font-bold text-gray-800 mb-2">結果発表</h1>
                <p class="text-gray-600">テイスティング結果</p>
            `;
            app.appendChild(header);
            
            // Calculate correct answers
            let correctCount = 0;
            for (let i = 0; i < state.servingOrder.length; i++) {
                if (state.playerArrangeOrder[i] === state.servingOrder[i]) {
                    correctCount++;
                }
            }
            
            // Results summary
            const resultsSummary = document.createElement('div');
            resultsSummary.className = 'bg-white rounded-lg shadow p-6 mb-8 text-center';
            
            // Add appropriate emoji based on score
            let emoji = '😐';
            let resultClass = 'text-blue-600';
            
            if (correctCount === state.servingOrder.length) {
                emoji = '🎉';
                resultClass = 'text-green-600';
            } else if (correctCount > state.servingOrder.length / 2) {
                emoji = '👏';
                resultClass = 'text-blue-600';
            } else if (correctCount === 0) {
                emoji = '😭';
                resultClass = 'text-red-600';
            }
            
            resultsSummary.innerHTML = `
                <div class="text-5xl mb-3">${emoji}</div>
                <div class="text-4xl font-bold ${resultClass} mb-3">
                    ${correctCount} / ${state.servingOrder.length}
                </div>
                <p class="text-lg">
                    ${correctCount === state.servingOrder.length 
                        ? '素晴らしい！全問正解です！' 
                        : correctCount > state.servingOrder.length / 2 
                            ? '良い結果です！' 
                            : 'また挑戦しましょう！'}
                </p>
            `;
            app.appendChild(resultsSummary);
            
            // Results details
            const resultsDetails = document.createElement('div');
            resultsDetails.className = 'bg-white rounded-lg shadow mb-8';
            
            // Results header
            const resultsHeader = document.createElement('div');
            resultsHeader.className = 'p-4 border-b bg-gray-50';
            resultsHeader.innerHTML = `
                <div class="grid grid-cols-2 gap-6">
                    <p class="font-medium">実際に提供されたもの</p>
                    <p class="font-medium">あなたの予想</p>
                </div>
            `;
            resultsDetails.appendChild(resultsHeader);
            
            // Results rows
            for (let i = 0; i < state.servingOrder.length; i++) {
                const actualItemIndex = state.servingOrder[i];
                const actualItem = state.items[actualItemIndex];
                
                const guessedItemIndex = state.playerArrangeOrder[i];
                const guessedItem = state.items[guessedItemIndex];
                
                const isCorrect = actualItemIndex === guessedItemIndex;
                
                const itemRow = document.createElement('div');
                itemRow.className = `p-4 border-b last:border-b-0 ${isCorrect ? 'bg-green-50' : 'bg-red-50'}`;
                
                // Actual item (what was served)
                let actualImageHtml = '';
                if (actualItem.image) {
                    actualImageHtml = `<img src="${actualItem.image}" alt="${actualItem.name}" class="w-12 h-12 object-cover rounded">`;
                } else {
                    actualImageHtml = `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>`;
                }
                
                // Guessed item
                let guessedImageHtml = '';
                if (guessedItem.image) {
                    guessedImageHtml = `<img src="${guessedItem.image}" alt="${guessedItem.name}" class="w-12 h-12 object-cover rounded">`;
                } else {
                    guessedImageHtml = `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>`;
                }
                
                itemRow.innerHTML = `
                    <div class="flex items-start mb-3">
                        <div class="bg-gray-100 rounded-full w-7 h-7 flex items-center justify-center mr-2 font-medium text-gray-800">
                            ${i + 1}
                        </div>
                        <div class="text-lg font-medium">${isCorrect ? '正解' : '不正解'}</div>
                        ${isCorrect 
                            ? '<i class="fas fa-check text-green-500 ml-2"></i>' 
                            : '<i class="fas fa-times text-red-500 ml-2"></i>'}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <div class="flex items-center">
                                ${actualImageHtml}
                                <div class="ml-3">
                                    <p class="font-medium">${actualItem.name}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex items-center">
                                ${guessedImageHtml}
                                <div class="ml-3">
                                    <p class="font-medium">${guessedItem.name}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                resultsDetails.appendChild(itemRow);
            }
            
            app.appendChild(resultsDetails);
            
            // Play again button
            const playAgainBtn = document.createElement('button');
            playAgainBtn.className = 'w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium text-lg transition-colors mb-4';
            playAgainBtn.textContent = '同じアイテムでもう一度遊ぶ';
            playAgainBtn.addEventListener('click', () => {
                // Reset game state but keep items
                state.gameMode = 'dealerChooseOrder';
                state.currentRole = 'dealer';
                state.currentItemIndex = 0;
                state.servingOrder = [...Array(state.items.length).keys()];
                state.playerGuesses = [];
                state.playerArrangeOrder = null;
                renderApp();
            });
            app.appendChild(playAgainBtn);
            
            // Back to setup button
            const backToSetupBtn = document.createElement('button');
            backToSetupBtn.className = 'w-full py-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium text-lg transition-colors';
            backToSetupBtn.textContent = 'セットアップ画面に戻る';
            backToSetupBtn.addEventListener('click', () => {
                // Reset completely
                state.gameMode = 'setup';
                state.currentRole = 'none';
                state.currentItemIndex = 0;
                state.servingOrder = [];
                state.playerGuesses = [];
                state.playerArrangeOrder = null;
                renderApp();
            });
            app.appendChild(backToSetupBtn);
        }

        // Role confirmation modal
        function renderRoleConfirmation(app, role) {
            const roleName = role === 'dealer' ? 'ディーラー' : 'プレイヤー';
            const roleIcon = role === 'dealer' ? 'fa-user-tie' : 'fa-user';
            const roleColor = role === 'dealer' ? 'blue' : 'green';
            
            // Clear main content
            app.innerHTML = '';
            
            const confirmationCard = document.createElement('div');
            confirmationCard.className = 'bg-white rounded-lg shadow-lg p-8 text-center fade-in';
            confirmationCard.innerHTML = `
                <div class="text-${roleColor}-600 text-5xl mb-6">
                    <i class="fas ${roleIcon}"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4">この画面は${roleName}用です</h2>
                <p class="text-gray-600 mb-8">あなたが${roleName}であることを確認してください。<br>役割が違う場合は「いいえ」をクリックしてください。</p>
                <div class="grid grid-cols-2 gap-4">
                    <button id="confirmNo" class="py-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium transition-colors">
                        いいえ
                    </button>
                    <button id="confirmYes" class="py-3 rounded-lg bg-${roleColor}-600 hover:bg-${roleColor}-700 text-white font-medium transition-colors">
                        はい、${roleName}です
                    </button>
                </div>
            `;
            app.appendChild(confirmationCard);
            
            // Event handlers
            document.getElementById('confirmYes').addEventListener('click', () => {
                state.currentRole = role;
                renderApp();
            });
            
            document.getElementById('confirmNo').addEventListener('click', () => {
                // Switch roles
                if (role === 'dealer') {
                    state.currentRole = 'player';
                    state.gameMode = 'playerGuess';
                } else {
                    // Show warning when switching to dealer
                    showPlayerToDealerWarning(() => {
                        state.currentRole = 'dealer';
                        state.gameMode = 'dealerShow';
                        renderApp();
                    });
                }
                renderApp();
            });
        }
    </script>
</body>
</html>
